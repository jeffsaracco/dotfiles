#!/usr/bin/env bash

set -e

./install-oh-my-zsh.sh

# Set ZSH as default shell
sudo chsh -s /usr/bin/zsh

# Install fzf
sudo apt-get install fzf

# Debian Buster has a old version of neovim so we need to install the AppImage
sudo apt-get install -y libfuse2

sudo apt install fuse -y
if [ $(getent group fuse) ]; then
  echo "fuse group exists. not creating"
else
  echo "group does not exist."
  sudo groupadd fuse
fi
user="$(whoami)"
sudo usermod -a -G fuse $user

wget https://github.com/neovim/neovim/releases/latest/download/nvim.appimage
chmod u+x nvim.appimage
sudo mv nvim.appimage /usr/local/bin/nvim

echo "Neovim installed"

# Use dotbot for the dotfiles
CONFIG="install.conf.json"
DOTBOT_DIR="dotbot"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd "${BASEDIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"

"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" "${@}"

echo "dotbot ran"

# Update node to a decent version
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo bash -
sudo apt-get install -y nodejs ripgrep

echo "Node installed"

npm install -g n

# Update npm
npm install -g npm@latest

echo "NPM updated"

# Start using latest node version
sudo n latest
echo "NPM using latest"

# Update path after installing latest node
PATH="$PATH"

# Install neovim LSP packages
npm install -g \
  typescript-language-server \
  vscode-langservers-extracted

echo "Neovim LSP packages installed"

echo $?

# Install vim plugins
echo "Installing vim plugins"
/usr/local/bin/nvim -es -u ~/.config/nvim/init.vim -i NONE -c "PlugInstall" -c "qa"

echo $?

# Set ZSH as default shell
sudo chsh -s $(which zsh) vscode

if [ "$CODESPACES" = "true" ]; then
  sudo apt install fd-find
  ln -s $(which fdfind) ~/.local/bin/fd
  sudo chsh -s /usr/bin/zsh
fi
